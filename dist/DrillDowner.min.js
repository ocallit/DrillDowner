class DrillDowner{static version="1.1.20";constructor(t,e,r={}){this.container="string"==typeof t?document.querySelector(t):t,this.dataArr=e,this.options=Object.assign({columns:[],totals:[],colProperties:{},groupOrder:[],groupOrderCombinations:null,ledger:[],idPrefix:"drillDowner"+Math.random().toString(36).slice(2)+"_",azBarSelector:null,azBarOrientation:"vertical",controlsSelector:null,showGrandTotals:!0,onLabelClick:null},r),this.options.ledger&&!Array.isArray(this.options.ledger)&&(this.options.ledger=[this.options.ledger]),this.options.ledger=this.options.ledger||[],0===this.options.groupOrder.length&&this.options.ledger.length>0?this.activeLedgerIndex=0:this.activeLedgerIndex=-1,this.options.totals=this.options.totals||[],this.options.columns=this.options.columns||[],this._defaultColumns=[...this.options.columns],this.options.colProperties=this.options.colProperties||{},this.azBar=this.options.azBarSelector?"string"==typeof this.options.azBarSelector?document.querySelector(this.options.azBarSelector):this.options.azBarSelector:null,this.controls=this.options.controlsSelector?"string"==typeof this.options.controlsSelector?document.querySelector(this.options.controlsSelector):this.options.controlsSelector:null,this._natSort=new Intl.Collator("es-MX",{sensitivity:"base",numeric:!0,caseFirst:"false"}).compare,this.grandTotals=this._calculateGrandTotals(),this._onDrillClick=this._onDrillClick.bind(this),this._onAZClick=this._onAZClick.bind(this),this.render()}getTable(){return this.table}changeGroupOrder(t){if(!this.controls)return this.options.groupOrder=t,this.render(),this;const e=this.controls.querySelector("select.drillDowner_modern_select");if(!e)return this;const r=t.join(",");let o=!1;if(this.options.groupOrderCombinations){for(let t=0;t<this.options.groupOrderCombinations.length;t++)if(this.options.groupOrderCombinations[t].join(",")===r){e.selectedIndex=t,o=!0;break}}else for(let t=0;t<e.options.length;t++)if(e.options[t].value===r){e.selectedIndex=t,o=!0;break}if(!o){const o=t.map((t=>this._getColLabel(t))).join(" → ");e.add(new Option(o,r)),e.value=r}return e.dispatchEvent(new Event("change")),this}collapseToLevel(t=0){if(!this.container)return this;if(!this.options.groupOrder||0===this.options.groupOrder.length)return this;(isNaN(t)||null==t||t<0)&&(t=0);const e=this.options.groupOrder.length;t>e&&(t=e);const r=this.container.querySelector("table.drillDowner_table");if(!r)return this;return r.querySelectorAll("tbody tr").forEach((e=>{const r=+e.getAttribute("data-level");e.style.display=!isNaN(r)&&r>t?"none":"";e.querySelectorAll(".drillDowner_drill_icon").forEach((t=>{t.classList.remove("drillDowner_drill_expanded"),t.classList.add("drillDowner_drill_collapsed")}))})),this._updateBreadcrumbVisuals(t),this}collapseAll(){return this.collapseToLevel(0)}expandAll(){return this.collapseToLevel(this.options.groupOrder.length)}_onTableClick(t){if("function"!=typeof this.options.onLabelClick)return;const e=t.target.closest('span[class*="drillDowner_indent_"]');if(!e)return;if(t.target.classList.contains("drillDowner_drill_icon"))return;const r=e.closest("tr");if(!r)return;const o=parseInt(r.getAttribute("data-level")||"0"),s=this.options.groupOrder[o],i=this._getHierarchyForRow(r),l={};i.forEach(((t,e)=>{const r=this.options.groupOrder[e];l[r]=t}));const n={label:e.innerText.trim(),level:o,column:s,hierarchyValues:i,hierarchyMap:l,rowElement:r};this.options.onLabelClick(n)}_getHierarchyForRow(t){const e=[];let r=t;for(;r;){const t=r.querySelector('span[class*="drillDowner_indent_"]');if(t){const r=t.cloneNode(!0);r.querySelectorAll(".drillDowner_drill_icon").forEach((t=>t.remove())),e.unshift(r.innerText.trim())}const o=r.getAttribute("data-parent");if(!o||""===o.trim())break;r=document.getElementById(o)}return e}destroy(){this.controls&&(this.controls.innerHTML=""),this.azBar&&(this.azBar=this._removeAllEventListeners(this.azBar),this.azBar.innerHTML=""),this.table&&(this.table=this._removeAllEventListeners(this.table)),this.container.innerHTML=""}render(){if(this.grandTotals=this._calculateGrandTotals(),0===this.options.groupOrder.length&&this.activeLedgerIndex>=0&&this.options.ledger[this.activeLedgerIndex]){const t=this.options.ledger[this.activeLedgerIndex];t.cols&&(this.options.columns=t.cols.filter((t=>!this.options.totals.includes(t))))}this.options.groupOrder.length>0&&(this.activeLedgerIndex=-1),this.azBar&&(this.azBar=this._removeAllEventListeners(this.azBar)),this.table&&(this.table=this._removeAllEventListeners(this.table)),this._renderControls(),this._renderAZBar(),this._renderTable(),this.options.groupOrder.length>0&&this.collapseToLevel(0)}_renderControls(){if(!this.controls)return;let t=this.controls.querySelector(".drillDowner_controls_container");t||(this.controls.innerHTML='\n                <div class="drillDowner_controls_container">\n                    <div class="drillDowner_breadcrumb_nav"></div>\n                    <div class="drillDowner_grouping_controls"></div>\n                </div>',t=this.controls.querySelector(".drillDowner_controls_container"),this._renderGroupingSelect(t.querySelector(".drillDowner_grouping_controls")),this._renderBreadcrumbs(t.querySelector(".drillDowner_breadcrumb_nav")))}_renderGroupingSelect(t){if(t.querySelector("select"))return;let e="";if(this.options.groupOrderCombinations)this.options.groupOrderCombinations.forEach(((t,r)=>{e+=`<option value="${r}">${t.map((t=>this._getColLabel(t))).join(" → ")}</option>`}));else if(this.options.groupOrder.length>0){this._generatePermutations(this.options.groupOrder.length).slice(0,9).forEach((t=>{const r=t.map((t=>this.options.groupOrder[t]));e+=`<option value="${r.join(",")}">${r.map((t=>this._getColLabel(t))).join(" → ")}</option>`}))}this.options.ledger.forEach(((t,r)=>{e+=`<option value="__LEDGER_${r}__">${t.label}</option>`})),t.innerHTML=`<div class="drillDowner_control_group">\n            <span class="drillDowner_control_label">Group by:</span>\n            <select class="drillDowner_modern_select">${e}</select>\n        </div>`,t.querySelector("select").addEventListener("change",(t=>{const e=t.target.value;e.startsWith("__LEDGER_")?(this.activeLedgerIndex=parseInt(e.replace("__LEDGER_","")),this.options.groupOrder=[]):(this.activeLedgerIndex=-1,this.options.columns=[...this._defaultColumns],this.options.groupOrderCombinations&&/^\d+$/.test(e)?this.options.groupOrder=this.options.groupOrderCombinations[parseInt(e)]:this.options.groupOrder=e.split(",")),this._renderBreadcrumbs(this.controls.querySelector(".drillDowner_breadcrumb_nav")),this.render()}))}_renderBreadcrumbs(t){t.innerHTML="";const e=[];if(this.options.groupOrder.length>0)this.options.groupOrder.forEach(((t,r)=>{e.push(`<button type="button" class="drillDowner_breadcrumb_item" data-level="${r}">\n                    <span>${this._getGroupIcon(t)} ${this._getColLabel(t)}</span>\n                </button>`),r<this.options.groupOrder.length-1&&e.push(`<button type="button" class="drillDowner_breadcrumb_arrow drillDowner_collapsed" data-arrow-level="${r}">\n                        <span class="drillDowner_arrow_icon">▶</span>\n                    </button>`)}));else if(this.activeLedgerIndex>=0){const t=this.options.ledger[this.activeLedgerIndex].label;e.push(`<span class="drillDowner_breadcrumb_item" style="cursor:default"><b>${t}</b></span>`)}t.innerHTML=e.join(""),t.querySelectorAll(".drillDowner_breadcrumb_item").forEach((t=>{void 0!==t.dataset.level&&(t.onclick=()=>this.collapseToLevel(parseInt(t.dataset.level)))})),t.querySelectorAll(".drillDowner_breadcrumb_arrow").forEach((t=>{t.onclick=()=>{const e=parseInt(t.dataset.arrowLevel);this.collapseToLevel(t.classList.contains("drillDowner_expanded")?e:e+1)}}))}_updateBreadcrumbVisuals(t){this.controls&&this.controls.querySelectorAll(".drillDowner_breadcrumb_arrow").forEach(((e,r)=>{const o=r<t;e.classList.toggle("drillDowner_expanded",o),e.classList.toggle("drillDowner_collapsed",!o)}))}_renderTable(){this.container.innerHTML="";const t=[...this.options.groupOrder.length>0?["Item"]:["#"],...this.options.totals.map((t=>this._getColLabel(t))),...this.options.columns.map((t=>this._getColLabel(t)))],e=document.createElement("table");e.className="drillDowner_table";const r=e.createTHead().insertRow();t.forEach(((t,e)=>{const o=document.createElement("th");if(e>0&&e<=this.options.totals.length){const r=this.options.totals[e-1];o.className=this._getColLabelClass(r)+(this.options.showGrandTotals?" drillDownerThTotal":""),o.innerHTML=this.options.showGrandTotals?`${t}<br><small>${this._formatGrandTotal(r)}</small>`:t}else e>this.options.totals.length?(o.className=this._getColLabelClass(this.options.columns[e-this.options.totals.length-1]),o.textContent=t):o.textContent=t;r.appendChild(o)}));const o=e.createTBody();if(0===this.options.groupOrder.length&&this.activeLedgerIndex>=0){const t=this.options.ledger[this.activeLedgerIndex],e=(t.sort||[]).map((t=>t.startsWith("-")?t.substring(1):t)),r=[...this.dataArr];this._sortData(r,e);const s={};let i=!1;this.options.totals.forEach((t=>{const e=this._getColProperty(t,"balanceBehavior"),r=e&&"number"==typeof e.initialBalance?e.initialBalance:0;s[t]=r,e&&"number"==typeof e.initialBalance&&(i=!0)}));const l=new Map;r.forEach((t=>{const e={};this.options.totals.forEach((r=>{if(this._getColProperty(r,"balanceBehavior")){const o=this._calculateRowImpact(t,r);s[r]+=o,e[r]=s[r]}})),l.set(t,e)})),this._sortData(this.dataArr,t.sort);const n=t.sort&&t.sort.length>0&&t.sort[0].startsWith("-"),a=()=>{const t=o.insertRow();t.className="drillDowner_initial_row",t.style.backgroundColor="#fafafa",t.style.fontStyle="italic",t.insertCell().innerHTML="",this.options.totals.forEach((e=>{const r=t.insertCell();r.className="drillDowner_num";const o=this._getColProperty(e,"balanceBehavior");if(o&&"number"==typeof o.initialBalance){const t=this._getColDecimals(e),s=this._getColFormatter(e),i=o.initialBalance;r.innerHTML=s?s(i,{}):DrillDowner.formatNumber(i,t)}else r.innerHTML=""}));let e=!1;this.options.columns.forEach((r=>{const o=t.insertCell();o.className=this._getColClass(r),e?o.innerHTML="":(o.innerHTML="Initial Balance",e=!0)}))};i&&!n&&a(),this.dataArr.forEach(((t,e)=>{const r=o.insertRow();e%2&&(r.className="drillDowner_even"),r.insertCell().innerHTML=`<span class="drillDowner_indent_0">${e+1}</span>`;const s=l.get(t)||{};this._appendDataCells(r,t,null,!0,s)})),i&&n&&a()}else this._sortData(this.dataArr,this.options.groupOrder),this._buildFlatRows(this.dataArr,this.options.groupOrder,0,{},[],o);if(this.options.showGrandTotals){const r=e.createTFoot().insertRow();t.forEach(((t,e)=>{const o=r.insertCell();if(0===e)o.innerHTML="<b>Total</b>",o.className="drillDowner_right";else if(e<=this.options.totals.length){const t=this.options.totals[e-1];o.className="drillDowner_num drillDownerTfootTotal "+this._getColLabelClass(t),o.innerHTML=this._formatGrandTotal(t)}}))}this.container.appendChild(e),this.table=e,e.querySelectorAll(".drillDowner_drill_icon").forEach((t=>t.onclick=t=>this._onDrillClick(t))),this.table.addEventListener("click",(t=>this._onTableClick(t)))}_buildFlatRows(t,e,r,o,s,i){if(r>=e.length)return;const l=e[r],n={};t.forEach((t=>{(n[t[l]]=n[t[l]]||[]).push(t)})),Object.keys(n).forEach(((t,a)=>{const c=n[t],h=e.slice(0,r+1).map(((e,s)=>s===r?t:o[e])).map((t=>this._sanitizeIdPart(t))),d=this.options.idPrefix+"row_"+h.join("_"),p=i.insertRow();p.id=d,p.setAttribute("data-level",r),p.setAttribute("data-parent",0===r?" ":this.options.idPrefix+"row_"+e.slice(0,r).map((t=>this._sanitizeIdPart(o[t]))).join("_")),a%2&&p.classList.add("drillDowner_even"),0===a&&p.classList.add("drillDowner_first_group");let u=" ";if(0===r){const e=String(t)[0]?.toUpperCase();e&&(u=`<span id="${this.options.idPrefix}az${this._sanitizeIdPart(e)}"></span>`)}const _=p.insertCell(),g=r<e.length?`<span class="drillDowner_drill_icon drillDowner_drill_collapsed" data-rowid="${d}" data-level="${r}"></span>`:"";_.innerHTML=`${u}<span class="drillDowner_indent_${r}">${g}${0===r?`<b>${t}</b>`:t}</span>`,this._appendDataCells(p,c[0],c,!1),this._buildFlatRows(c,e,r+1,{...o,[l]:t},s,i),r===e.length-1&&c.forEach(((t,e)=>{const o=i.insertRow();o.id=d+"_detail_"+e,o.setAttribute("data-level",r+1),o.setAttribute("data-parent",d),e%2&&o.classList.add("drillDowner_even");o.insertCell().innerHTML=`<span class="drillDowner_indent_${r+1}">${t[l]}</span>`,this._appendDataCells(o,t,null,!0)}))}))}_appendDataCells(t,e,r,o,s={}){this.options.totals.forEach((o=>{const i=t.insertCell();i.className="drillDowner_num";const l=this._getColDecimals(o),n=this._getColFormatter(o);if(r){const t=this._getColProperty(o,"subTotalBy");if(t){const s={};r.forEach((e=>{const r=this._getColProperty(o,"balanceBehavior")?this._calculateRowImpact(e,o):Number(e[o]);s[e[t]]=(s[e[t]]||0)+r}));const a=Object.entries(s).map((([t,e])=>`${DrillDowner.formatNumber(e,l)} ${t}`)).join(", ")||"-";i.innerHTML=n?n(a,e):a}else{let t;t=this._getColProperty(o,"balanceBehavior")?r.reduce(((t,e)=>t+this._calculateRowImpact(e,o)),0):r.reduce(((t,e)=>t+(Number(e[o])||0)),0),i.innerHTML=n?n(t,e):DrillDowner.formatNumber(t,l)}}else{let t;t=s&&s.hasOwnProperty(o)?s[o]:this._getColProperty(o,"balanceBehavior")?this._calculateRowImpact(e,o):e[o],i.innerHTML=n?n(t,e):DrillDowner.formatNumber(t,l)}})),this.options.columns.forEach((s=>{const i=t.insertCell();i.className=this._getColClass(s);let l="";r&&this._getColTogglesUp(s)?l=Array.from(new Set(r.map((t=>t[s])))).join(", "):r&&!o||(l=e[s]);const n=this._getColFormatter(s);i.innerHTML=n?n(l,e):l}))}_getColProperty(t,e,r=null){return this.options.colProperties[t]?.[e]??r}_getColDecimals(t){return this._getColProperty(t,"decimals",2)}_getColLabel(t){return this._getColProperty(t,"label",t.charAt(0).toUpperCase()+t.slice(1))}_getGroupIcon(t){return this._getColProperty(t,"icon","")}_getColClass(t){return this._getColProperty(t,"class","")}_getColLabelClass(t){return this._getColProperty(t,"labelClass","")}_getColTogglesUp(t){return this._getColProperty(t,"togglesUp",!1)}_getColFormatter(t){return this._getColProperty(t,"formatter",null)}_sanitizeIdPart(t){return String(t??"").normalize("NFKD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-zA-Z0-9_-]/g,"_")}_calculateRowImpact(t,e){const r=this._getColProperty(e,"balanceBehavior");if(!r)return Number(t[e])||0;let o=0;return Array.isArray(r.add)&&r.add.forEach((e=>{o+=Number(t[e])||0})),Array.isArray(r.subtract)&&r.subtract.forEach((e=>{o-=Number(t[e])||0})),o}_onDrillClick(t){const e=t.target,r=e.dataset.rowid,o=e.classList.contains("drillDowner_drill_expanded");e.classList.toggle("drillDowner_drill_expanded",!o),e.classList.toggle("drillDowner_drill_collapsed",o);const s=(t,e)=>{this.table.querySelectorAll(`tr[data-parent="${t}"]`).forEach((t=>{if(t.style.display=e?"":"none",!e){const e=t.querySelector(".drillDowner_drill_icon");e&&(e.classList.remove("drillDowner_drill_expanded"),e.classList.add("drillDowner_drill_collapsed")),s(t.id,!1)}}))};s(r,!o)}_onAZClick(){setTimeout((()=>window.scrollBy(0,-30)),1)}_renderAZBar(){if(!this.azBar||0===this.options.groupOrder.length)return void(this.azBar&&(this.azBar.innerHTML=""));const t=this.options.groupOrder[0],e=new Set(this.dataArr.map((e=>String(e[t]||"")[0]?.toUpperCase())));let r="";for(let t=65;t<=90;t++){const o=String.fromCharCode(t);r+=e.has(o)?`<div><a href="#${this.options.idPrefix}az${this._sanitizeIdPart(o)}" aria-label="Ir a la letra ${o}" class="drillDowner_az_link">${o}</a></div>`:`<div class="drillDowner_az_dimmed">${o}</div>`}this.azBar.innerHTML=r,this.azBar.querySelectorAll(".drillDowner_az_link").forEach((t=>t.onclick=()=>this._onAZClick())),this._applyAzBarOrientation()}_applyAzBarOrientation(){if(!this.azBar)return;this.azBar.classList.add("drillDowner_az_bar");const t=(this.options.azBarOrientation||"vertical").toLowerCase();"horizontal"===t||"h"===t||"row"===t?this.azBar.classList.add("drillDowner_az_bar_horizontal"):this.azBar.classList.remove("drillDowner_az_bar_horizontal")}_calculateGrandTotals(){const t={};return this.options.totals.forEach((e=>{const r=this._getColProperty(e,"subTotalBy");if(r){const o={};this.dataArr.forEach((t=>{if(null!=t[e]||this._getColProperty(e,"balanceBehavior")){const s=this._getColProperty(e,"balanceBehavior")?this._calculateRowImpact(t,e):Number(t[e])||0;o[t[r]]=(o[t[r]]||0)+s}})),t[e]=o}else{const r=this._getColProperty(e,"balanceBehavior");if(r){const o="number"==typeof r.initialBalance?r.initialBalance:0;t[e]=this.dataArr.reduce(((t,r)=>t+this._calculateRowImpact(r,e)),o)}else t[e]=this.dataArr.reduce(((t,r)=>t+(Number(r[e])||0)),0)}})),t}_formatGrandTotal(t){const e=this.grandTotals[t],r=this._getColDecimals(t);return"object"!=typeof e?DrillDowner.formatNumber(e,r):Object.entries(e).map((([t,e])=>`${DrillDowner.formatNumber(e,r)} ${t}`)).join("<br>")||"-"}_sortData(t,e){return e?.length?t.sort(((t,r)=>{for(let o of e){const e=o.startsWith("-"),s=e?o.substring(1):o,i=this._natSort(String(t[s]||""),String(r[s]||""));if(0!==i)return e?-i:i}return 0})):t}static formatNumber(t,e){return null==t||isNaN(t)||""===t?t||"":Number(t).toLocaleString("en-US",{minimumFractionDigits:e,maximumFractionDigits:e})}_removeAllEventListeners(t){if(!t)return t;const e=t.cloneNode(!0);return t.parentNode.replaceChild(e,t),e}_generatePermutations(t,e=9){const r=[],o=(t,s=0)=>{if(!(r.length>=e))if(s!==t.length-1){for(let i=s;i<t.length;i++)if([t[s],t[i]]=[t[i],t[s]],o(t,s+1),[t[s],t[i]]=[t[i],t[s]],r.length>=e)return}else r.push([...t])};return o(Array.from({length:t},((t,e)=>e))),r}}