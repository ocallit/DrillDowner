class DrillDowner{constructor(t,e,o={}){this.container="string"==typeof t?document.querySelector(t):t,this.dataArr=e,this.options=Object.assign({columns:[],totals:[],colProperties:{},groupOrder:[],groupOrderCombinations:null,idPrefix:"drillDowner"+Math.random().toString(36).slice(2)+"_",azBarSelector:null,controlsSelector:null,showGrandTotals:!0},o),this.options.totals=this.options.totals||[],this.options.columns=this.options.columns||[],this.options.colProperties=this.options.colProperties||{},this.azBar=this.options.azBarSelector?"string"==typeof this.options.azBarSelector?document.querySelector(this.options.azBarSelector):this.options.azBarSelector:null,this.controls=this.options.controlsSelector?"string"==typeof this.options.controlsSelector?document.querySelector(this.options.controlsSelector):this.options.controlsSelector:null,this._natSort=new Intl.Collator("es-MX",{sensitivity:"base",numeric:!0,caseFirst:"false"}).compare,this.grandTotals=this._calculateGrandTotals(),this._onDrillClick=this._onDrillClick.bind(this),this._onAZClick=this._onAZClick.bind(this),this.render()}collapseToLevel(t=0){(isNaN(t)||null==t||t<0)&&(t=0),t>=this.options.groupOrder.length&&(t=this.options.groupOrder.length-1);return this.container.querySelector("table.drillDowner_table").querySelectorAll("tbody tr").forEach((e=>{const o=+e.getAttribute("data-level");e.style.display=o>t?"none":"";e.querySelectorAll(".drillDowner_drill_icon").forEach((t=>{t.classList.remove("drillDowner_drill_expanded"),t.classList.add("drillDowner_drill_collapsed")}))})),this._updateBreadcrumbArrows(t),this}collapseAll(){return this.collapseToLevel(0),this}expandAll(){return this.collapseToLevel(this.options.groupOrder.length-1),this}changeGroupOrder(t){return this.options.groupOrder=t,this.render(),this}destroy(){this.controls&&(this.controls=this._removeAllEventListeners(this.controls),this.controls.innerHTML=""),this.azBar&&(this.azBar=this._removeAllEventListeners(this.azBar),this.azBar.innerHTML=""),this.table&&(this.table=this._removeAllEventListeners(this.table)),this.container.innerHTML=""}render(){this.grandTotals=this._calculateGrandTotals(),this.controls&&(this.controls=this._removeAllEventListeners(this.controls)),this.azBar&&(this.azBar=this._removeAllEventListeners(this.azBar)),this.table&&(this.table=this._removeAllEventListeners(this.table)),this._renderControls(),this._renderAZBar(),this._renderTable(),this.collapseToLevel(0)}getTable(){return this.container.querySelector("table.drillDowner_table")}_renderControls(){if(!this.controls)return;const t=this.options.idPrefix,e=[];this.options.groupOrder.forEach(((t,o)=>{const r=this._getColLabel(t),s=this._getGroupIcon(t);if(e.push(`\n            <button type="button" class="drillDowner_breadcrumb_item" data-level="${o}">\n                <span>${s} ${r}</span>\n            </button>\n        `),o<this.options.groupOrder.length-1){const t=this._getColLabel(this.options.groupOrder[o+1]);e.push(`\n                <button type="button" class="drillDowner_breadcrumb_arrow drillDowner_collapsed"\n                     data-arrow-level="${o}"\n                     title="Click to expand to ${t} level">\n                    <span class="drillDowner_arrow_icon">▶</span>\n                </button>\n            `)}}));const o=e.join("");let r="",s=!0;if(this.options.groupOrderCombinations)this.options.groupOrderCombinations.forEach(((t,e)=>{const o=t.map((t=>this._getColLabel(t)));r+=`<option value="${e}">${o.join(" → ")}</option>`}));else{const t=this.options.groupOrder.length;if(0===t)r='<option value="">No grouping available</option>',s=!1;else if(1===t)s=!1;else if(2===t){const t=this.options.groupOrder.map((t=>this._getColLabel(t)));r=`\n                <option value="0,1">${t[0]} → ${t[1]}</option>\n                <option value="1,0">${t[1]} → ${t[0]}</option>\n            `}else if(3===t){const t=this.options.groupOrder.map((t=>this._getColLabel(t)));r=`\n                <option value="0,1,2">${t[0]} → ${t[1]} → ${t[2]}</option>\n                <option value="0,2,1">${t[0]} → ${t[2]} → ${t[1]}</option>\n                <option value="1,0,2">${t[1]} → ${t[0]} → ${t[2]}</option>\n                <option value="1,2,0">${t[1]} → ${t[2]} → ${t[0]}</option>\n                <option value="2,0,1">${t[2]} → ${t[0]} → ${t[1]}</option>\n                <option value="2,1,0">${t[2]} → ${t[1]} → ${t[0]}</option>\n            `}else{const e=this._generatePermutations(t).slice(0,9),o=this.options.groupOrder.map((t=>this._getColLabel(t)));e.forEach((t=>{const e=t.map((t=>o[t])),s=t.join(",");r+=`<option value="${s}">${e.join(" → ")}</option>`}))}}const l=s?`\n        <div class="drillDowner_grouping_controls">\n            <div class="drillDowner_control_group">\n                <span class="drillDowner_control_label">Group by:</span>\n                <select class="drillDowner_modern_select" id="${t}grouporder">\n                    ${r}\n                </select>\n            </div>\n        </div>\n    `:"";this.controls=this._removeAllEventListeners(this.controls),this.controls.innerHTML=`\n        <div class="drillDowner_controls_container">\n            <div class="drillDowner_breadcrumb_nav">\n                ${o}\n            </div>\n            ${l}\n        </div>\n    `;this.controls.querySelectorAll(".drillDowner_breadcrumb_item").forEach((t=>{t.addEventListener("click",(t=>{this.collapseToLevel(parseInt(t.currentTarget.dataset.level))}))}));if(this.controls.querySelectorAll(".drillDowner_breadcrumb_arrow").forEach((t=>{t.addEventListener("click",(t=>{const e=parseInt(t.currentTarget.dataset.arrowLevel),o=e+1;t.currentTarget.classList.contains("drillDowner_expanded")?this.collapseToLevel(e):this.collapseToLevel(o)}))})),s){const e=this.controls.querySelector("#"+t+"grouporder");e&&e.addEventListener("change",(t=>{if(this.options.groupOrderCombinations){const e=parseInt(t.target.value);if(e>=0&&e<this.options.groupOrderCombinations.length){const t=this.options.groupOrderCombinations[e];this.changeGroupOrder(t)}}else{const e=t.target.value.split(",").map((t=>parseInt(t))).map((t=>this.options.groupOrder[t]));this.changeGroupOrder(e)}}))}this._updateBreadcrumbArrows(0)}_updateBreadcrumbArrows(t=0){if(!this.controls)return;this.controls.querySelectorAll(".drillDowner_breadcrumb_arrow").forEach(((e,o)=>{const r=o+1;if(r<this.options.groupOrder.length){const o=this._getColLabel(this.options.groupOrder[r]);e.classList.remove("drillDowner_expanded","drillDowner_collapsed"),t>=r?(e.classList.add("drillDowner_expanded"),e.setAttribute("title",`Collapsa a ${o} level`)):(e.classList.add("drillDowner_collapsed"),e.setAttribute("title",`Expande a ${o} level`))}}))}_generatePermutations(t){if(t<=1)return 0===t?[]:[[0]];const e=[];return function t(o,r=0){if(r!==o.length-1)for(let e=r;e<o.length;e++)[o[r],o[e]]=[o[e],o[r]],t(o,r+1),[o[r],o[e]]=[o[e],o[r]];else e.push([...o])}(Array.from({length:t},((t,e)=>e))),e}_renderAZBar(){if(!this.azBar)return;const t=this._getGroupCol(0),e=new Set(this.dataArr.map((e=>(e[t]||"")[0]?.toUpperCase())));let o="";for(let t=65;t<=90;t++){const r=String.fromCharCode(t),s=`${this.options.idPrefix}az${r}`;e.has(r)?o+=`<div><a href="#${s}" class="drillDowner_az_link ${this.options.idPrefix}az_link">${r}</a></div>`:o+=`<div class="drillDowner_az_dimmed">${r}</div>`}this.azBar=this._removeAllEventListeners(this.azBar),this.azBar.innerHTML=o;this.azBar.querySelectorAll("."+this.options.idPrefix+"az_link").forEach((t=>{t.addEventListener("click",this._onAZClick)}))}_renderTable(){this.container.innerHTML="";const t=["Item",...this.options.totals.map((t=>{const e=this._getColProperty(t,"subTotalBy");if(e){return`${this._getColLabel(t)} (${this._getColLabel(e)})`}return this._getColLabel(t)})),...this.options.columns.map((t=>this._getColLabel(t)))],e=document.createElement("thead"),o=document.createElement("tr");t.forEach(((t,e)=>{let r="",s=t;if(0===e);else if(e<=this.options.totals.length){const o=this.options.totals[e-1];if(r=this._getColLabelClass(o),this.options.showGrandTotals){s=`${t}<br><small>${this._formatGrandTotal(o)}</small>`,r+=" drillDownerThTotal"}}else{const t=this.options.columns[e-this.options.totals.length-1];r=this._getColLabelClass(t)}const l=document.createElement("th");l.className=r,l.innerHTML=s,o.appendChild(l)})),e.appendChild(o);const r=[];this.azAnchoredLetters=new Set,this._sortAsc(this.dataArr,this.options.groupOrder),this._buildFlatRows(this.dataArr,this.options.groupOrder,0,{},r);const s=document.createElement("tbody");r.forEach((t=>s.appendChild(t)));let l=null;if(this.options.showGrandTotals){l=document.createElement("tfoot");const e=document.createElement("tr");t.forEach(((t,o)=>{let r,s;if(0===o)s="<b>Total</b>",r=" drillDowner_right";else if(o<=this.options.totals.length){const t=this.options.totals[o-1];r=this._getColLabelClass(t)+" drillDowner_num drillDownerTfootTotal",s=`${this._formatGrandTotal(t)}`}else{const t=this.options.columns[o-this.options.totals.length-1];r=this._getColLabelClass(t),s=""}const l=document.createElement("td");l.className=r,l.innerHTML=s,e.appendChild(l)})),l.appendChild(e)}const i=document.createElement("table");i.className="drillDowner_table",i.appendChild(e),i.appendChild(s),this.options.showGrandTotals&&l&&i.appendChild(l),this.container.appendChild(i);i.querySelectorAll("."+this.options.idPrefix+"drill_icon").forEach((t=>{t.addEventListener("click",this._onDrillClick)})),this.table=i}_buildFlatRows(t,e,o,r,s){if(o>=e.length)return;const l=this._getGroupCol(o),i=this._getGroupKey(o),n={};t.forEach((t=>{const e=t[l];e in n||(n[e]=[]),n[e].push(t)}));Object.keys(n).forEach(((t,a)=>{const c=n[t],d=e.slice(0,o+1).map(((e,s)=>r[e]||(s===o?t:""))),h=this.options.idPrefix+"row_"+d.join("_").replace(/\s/g,"_"),p=0===o?"":this.options.idPrefix+"row_"+e.slice(0,o).map((t=>r[t])).join("_").replace(/\s/g,"_"),u=document.createElement("tr");u.id=h,u.setAttribute("data-level",o),u.setAttribute("data-parent",p),u.classList.add("drillDowner_row_"+i),a%2==1&&u.classList.add("drillDowner_even"),0===a&&u.classList.add("drillDowner_first_group");let _="";if(0===o&&t.length>0){const e=t.charAt(0).toUpperCase();if(!this.azAnchoredLetters.has(e)){_=`<span id="${this.options.idPrefix+"az"+e}" class="drillDowner_az_anchor"></span>`,this.azAnchoredLetters.add(e)}}let g,m="";o<e.length-1&&(m=`<span class="${this.options.idPrefix}drill_icon drillDowner_drill_icon drillDowner_drill_collapsed" data-rowid="${h}" data-level="${o}"></span>`),g=0===o?`<span class="drillDowner_indent_${o}">${m}<b>${t}</b></span>`:`<span class="drillDowner_indent_${o}">${m}${t}</span>`;const b=document.createElement("td");b.innerHTML=_+g,u.appendChild(b),this.options.totals.forEach((t=>{const e=this._getColDecimals(t),o=this._getColProperty(t,"subTotalBy"),r=document.createElement("td");if(r.className="drillDowner_num",o){const s={};c.forEach((e=>{const r=e[o];null!=e[t]&&r&&(s[r]=(s[r]||0)+e[t])})),r.innerHTML=Object.entries(s).map((([t,o])=>DrillDowner.formatNumber(o,e)+" "+t)).join(", ")||"-"}else{const o=c.reduce(((e,o)=>e+(o[t]||0)),0);r.innerHTML=DrillDowner.formatNumber(o,e)}u.appendChild(r)})),this.options.columns.forEach((t=>{const r=this._getColTogglesUp(t),s=this._getColClass(t),l=this._getColFormatter(t),i=document.createElement("td");if(i.className=s,r){const e=new Set;for(const o of c){let r=t in o?o[t]:"";l&&"function"==typeof l&&(r=l(r,o)),r&&""!==r&&e.add(r)}i.innerHTML=Array.from(e).join(", ")}else if(o===e.length-1&&1===c.length){const e=c[0];let o=t in e?e[t]:"";l&&"function"==typeof l&&(o=l(o,e)),i.innerHTML=o}else i.innerHTML="";u.appendChild(i)})),s.push(u),o<e.length-1&&this._buildFlatRows(c,e,o+1,{...r,[l]:t},s)}))}_onDrillClick(t){const e=t.target,o=e.dataset.rowid,r=+e.dataset.level,s=e.closest("table").querySelectorAll("tbody tr");e.classList.contains("drillDowner_drill_collapsed")?(e.classList.remove("drillDowner_drill_collapsed"),e.classList.add("drillDowner_drill_expanded"),this._setChildrenVisible(o,r,!0,s)):(e.classList.remove("drillDowner_drill_expanded"),e.classList.add("drillDowner_drill_collapsed"),this._setChildrenVisible(o,r,!1,s))}_setChildrenVisible(t,e,o,r){r.forEach((e=>{if(e.getAttribute("data-parent")===t)if(o)e.style.display="";else{e.style.display="none";e.querySelectorAll(".drillDowner_drill_icon").forEach((t=>{t.classList.remove("drillDowner_drill_expanded"),t.classList.add("drillDowner_drill_collapsed")})),this._setChildrenVisible(e.id,+e.getAttribute("data-level"),!1,r)}}))}_onAZClick(){setTimeout((function(){window.scrollBy(0,-30)}),1)}static formatNumber(t,e){return isNaN(t)?t:Number(t).toLocaleString("en-US",{minimumFractionDigits:e,maximumFractionDigits:e})}_sortAsc(t,e){const o=this._natSort;return t.sort(((t,r)=>{for(let s of e){const e=(t[s]??"").toString(),l=(r[s]??"").toString(),i=o(e,l);if(0!==i)return i}return 0})),t}_calculateGrandTotals(){const t={};return this.options.totals.forEach((e=>{const o=this._getColProperty(e,"subTotalBy");if(o){const r={};this.dataArr.forEach((t=>{const s=t[o];null!=t[e]&&s&&(r[s]=(r[s]||0)+t[e])})),t[e]=r}else t[e]=this.dataArr.reduce(((t,o)=>t+(o[e]||0)),0)})),t}_formatGrandTotal(t){const e=this._getColDecimals(t),o=this._getColProperty(t,"subTotalBy"),r=this.grandTotals[t];if(o){return Object.entries(r).map((([t,o])=>DrillDowner.formatNumber(o,e)+" "+t)).join("<br>")||"-"}return DrillDowner.formatNumber(r,e)}_getColProperty(t,e,o=null){return this.options.colProperties[t]&&void 0!==this.options.colProperties[t][e]?this.options.colProperties[t][e]:o}_getColDecimals(t){return this._getColProperty(t,"decimals",2)}_getColLabel(t){return this._getColProperty(t,"label",t.charAt(0).toUpperCase()+t.slice(1))}_getGroupIcon(t){return this._getColProperty(t,"icon","")}_getColClass(t){return this._getColProperty(t,"class","")}_getColLabelClass(t){return this._getColProperty(t,"labelClass","")}_getColKey(t){return this._getColProperty(t,"key",t)}_getColTogglesUp(t){return this._getColProperty(t,"togglesUp",!1)}_getColFormatter(t){return this._getColProperty(t,"formatter",null)}_getGroupCol(t){return this.options.groupOrder[t]}_getGroupKey(t){return this._getColKey(this._getGroupCol(t))}_removeAllEventListeners(t){if(!t)return;const e=t.cloneNode(!0);return t.parentNode?(t.parentNode.replaceChild(e,t),e):t}}