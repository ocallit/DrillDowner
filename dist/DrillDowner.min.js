class DrillDowner{constructor(t,e,r={}){this.container="string"==typeof t?document.querySelector(t):t,this.dataArr=e,this.options=Object.assign({columns:[],totals:[],colProperties:{},groupOrder:[],groupOrderCombinations:null,ledger:[],idPrefix:"drillDowner"+Math.random().toString(36).slice(2)+"_",azBarSelector:null,controlsSelector:null,showGrandTotals:!0},r),this.options.ledger&&!Array.isArray(this.options.ledger)&&(this.options.ledger=[this.options.ledger]),this.options.ledger=this.options.ledger||[],0===this.options.groupOrder.length&&this.options.ledger.length>0?this.activeLedgerIndex=0:this.activeLedgerIndex=-1,this.options.totals=this.options.totals||[],this.options.columns=this.options.columns||[],this._defaultColumns=[...this.options.columns],this.options.colProperties=this.options.colProperties||{},this.azBar=this.options.azBarSelector?"string"==typeof this.options.azBarSelector?document.querySelector(this.options.azBarSelector):this.options.azBarSelector:null,this.controls=this.options.controlsSelector?"string"==typeof this.options.controlsSelector?document.querySelector(this.options.controlsSelector):this.options.controlsSelector:null,this._natSort=new Intl.Collator("es-MX",{sensitivity:"base",numeric:!0,caseFirst:"false"}).compare,this.grandTotals=this._calculateGrandTotals(),this._onDrillClick=this._onDrillClick.bind(this),this._onAZClick=this._onAZClick.bind(this),this.render()}getTable(){return this.table}changeGroupOrder(t){if(!this.controls)return this.options.groupOrder=t,this.render(),this;const e=this.controls.querySelector("select.drillDowner_modern_select");if(!e)return this;const r=t.join(",");let o=!1;for(let t=0;t<e.options.length;t++)if(e.options[t].value===r){e.selectedIndex=t,o=!0;break}if(!o){const o=t.map((t=>this._getColLabel(t))).join(" → ");e.add(new Option(o,r)),e.value=r}return e.dispatchEvent(new Event("change")),this}collapseToLevel(t=0){if(!this.container)return this;if(!this.options.groupOrder||0===this.options.groupOrder.length)return this;(isNaN(t)||null==t||t<0)&&(t=0);const e=this.options.groupOrder.length-1;t>e&&(t=e);const r=this.container.querySelector("table.drillDowner_table");if(!r)return this;return r.querySelectorAll("tbody tr").forEach((e=>{const r=+e.getAttribute("data-level");e.style.display=r>t?"none":"";e.querySelectorAll(".drillDowner_drill_icon").forEach((t=>{t.classList.remove("drillDowner_drill_expanded"),t.classList.add("drillDowner_drill_collapsed")}))})),this._updateBreadcrumbVisuals(t),this}collapseAll(){return this.collapseToLevel(0)}expandAll(){return this.collapseToLevel(this.options.groupOrder.length-1)}destroy(){this.controls&&(this.controls.innerHTML=""),this.azBar&&(this.azBar=this._removeAllEventListeners(this.azBar),this.azBar.innerHTML=""),this.table&&(this.table=this._removeAllEventListeners(this.table)),this.container.innerHTML=""}render(){if(this.grandTotals=this._calculateGrandTotals(),0===this.options.groupOrder.length&&this.activeLedgerIndex>=0&&this.options.ledger[this.activeLedgerIndex]){const t=this.options.ledger[this.activeLedgerIndex];t.cols&&(this.options.columns=t.cols)}this.options.groupOrder.length>0&&(this.activeLedgerIndex=-1),this.azBar&&(this.azBar=this._removeAllEventListeners(this.azBar)),this.table&&(this.table=this._removeAllEventListeners(this.table)),this._renderControls(),this._renderAZBar(),this._renderTable(),this.options.groupOrder.length>0&&this.collapseToLevel(0)}_renderControls(){if(!this.controls)return;let t=this.controls.querySelector(".drillDowner_controls_container");t||(this.controls.innerHTML='\n                <div class="drillDowner_controls_container">\n                    <div class="drillDowner_breadcrumb_nav"></div>\n                    <div class="drillDowner_grouping_controls"></div>\n                </div>',t=this.controls.querySelector(".drillDowner_controls_container"),this._renderGroupingSelect(t.querySelector(".drillDowner_grouping_controls")),this._renderBreadcrumbs(t.querySelector(".drillDowner_breadcrumb_nav")))}_renderGroupingSelect(t){if(t.querySelector("select"))return;let e="";if(this.options.groupOrderCombinations)this.options.groupOrderCombinations.forEach(((t,r)=>{e+=`<option value="${r}">${t.map((t=>this._getColLabel(t))).join(" → ")}</option>`}));else if(this.options.groupOrder.length>0){this._generatePermutations(this.options.groupOrder.length).slice(0,9).forEach((t=>{const r=t.map((t=>this.options.groupOrder[t]));e+=`<option value="${r.join(",")}">${r.map((t=>this._getColLabel(t))).join(" → ")}</option>`}))}this.options.ledger.forEach(((t,r)=>{e+=`<option value="__LEDGER_${r}__">${t.label}</option>`})),t.innerHTML=`<div class="drillDowner_control_group">\n            <span class="drillDowner_control_label">Group by:</span>\n            <select class="drillDowner_modern_select">${e}</select>\n        </div>`,t.querySelector("select").addEventListener("change",(t=>{const e=t.target.value;e.startsWith("__LEDGER_")?(this.activeLedgerIndex=parseInt(e.replace("__LEDGER_","")),this.options.groupOrder=[]):(this.activeLedgerIndex=-1,this.options.columns=[...this._defaultColumns],this.options.groupOrderCombinations?this.options.groupOrder=this.options.groupOrderCombinations[parseInt(e)]:this.options.groupOrder=e.split(",")),this._renderBreadcrumbs(this.controls.querySelector(".drillDowner_breadcrumb_nav")),this.render()}))}_renderBreadcrumbs(t){t.innerHTML="";const e=[];if(this.options.groupOrder.length>0)this.options.groupOrder.forEach(((t,r)=>{e.push(`<button type="button" class="drillDowner_breadcrumb_item" data-level="${r}">\n                    <span>${this._getGroupIcon(t)} ${this._getColLabel(t)}</span>\n                </button>`),r<this.options.groupOrder.length-1&&e.push(`<button type="button" class="drillDowner_breadcrumb_arrow drillDowner_collapsed" data-arrow-level="${r}">\n                        <span class="drillDowner_arrow_icon">▶</span>\n                    </button>`)}));else if(this.activeLedgerIndex>=0){const t=this.options.ledger[this.activeLedgerIndex].label;e.push(`<span class="drillDowner_breadcrumb_item" style="cursor:default"><b>${t}</b></span>`)}t.innerHTML=e.join(""),t.querySelectorAll(".drillDowner_breadcrumb_item").forEach((t=>{void 0!==t.dataset.level&&(t.onclick=()=>this.collapseToLevel(parseInt(t.dataset.level)))})),t.querySelectorAll(".drillDowner_breadcrumb_arrow").forEach((t=>{t.onclick=()=>{const e=parseInt(t.dataset.arrowLevel);this.collapseToLevel(t.classList.contains("drillDowner_expanded")?e:e+1)}}))}_updateBreadcrumbVisuals(t){this.controls&&this.controls.querySelectorAll(".drillDowner_breadcrumb_arrow").forEach(((e,r)=>{const o=r<t;e.classList.toggle("drillDowner_expanded",o),e.classList.toggle("drillDowner_collapsed",!o)}))}_renderTable(){this.container.innerHTML="";const t=[...this.options.groupOrder.length>0?["Item"]:["#"],...this.options.totals.map((t=>this._getColLabel(t))),...this.options.columns.map((t=>this._getColLabel(t)))],e=document.createElement("table");e.className="drillDowner_table";const r=e.createTHead().insertRow();t.forEach(((t,e)=>{const o=document.createElement("th");if(e>0&&e<=this.options.totals.length){const r=this.options.totals[e-1];o.className=this._getColLabelClass(r)+(this.options.showGrandTotals?" drillDownerThTotal":""),o.innerHTML=this.options.showGrandTotals?`${t}<br><small>${this._formatGrandTotal(r)}</small>`:t}else e>this.options.totals.length?(o.className=this._getColLabelClass(this.options.columns[e-this.options.totals.length-1]),o.textContent=t):o.textContent=t;r.appendChild(o)}));const o=e.createTBody();if(0===this.options.groupOrder.length&&this.activeLedgerIndex>=0){const t=this.options.ledger[this.activeLedgerIndex];this._sortAsc(this.dataArr,t.sort).forEach(((t,e)=>{const r=o.insertRow();e%2&&(r.className="drillDowner_even"),r.insertCell().innerHTML=`<span class="drillDowner_indent_0">${e+1}</span>`,this._appendDataCells(r,t,null,!0)}))}else this._sortAsc(this.dataArr,this.options.groupOrder),this._buildFlatRows(this.dataArr,this.options.groupOrder,0,{},[],o);if(this.options.showGrandTotals){const r=e.createTFoot().insertRow();t.forEach(((t,e)=>{const o=r.insertCell();if(0===e)o.innerHTML="<b>Total</b>",o.className="drillDowner_right";else if(e<=this.options.totals.length){const t=this.options.totals[e-1];o.className="drillDowner_num drillDownerTfootTotal "+this._getColLabelClass(t),o.innerHTML=this._formatGrandTotal(t)}}))}this.container.appendChild(e),this.table=e,e.querySelectorAll(".drillDowner_drill_icon").forEach((t=>t.onclick=t=>this._onDrillClick(t)))}_buildFlatRows(t,e,r,o,s,l){if(r>=e.length)return;const i=e[r],n={};t.forEach((t=>{(n[t[i]]=n[t[i]]||[]).push(t)})),Object.keys(n).forEach(((t,a)=>{const c=n[t],d=e.slice(0,r+1).map(((e,s)=>s===r?t:o[e])),h=this.options.idPrefix+"row_"+d.join("_").replace(/\s/g,"_"),p=l.insertRow();p.id=h,p.setAttribute("data-level",r),p.setAttribute("data-parent",0===r?"":this.options.idPrefix+"row_"+e.slice(0,r).map((t=>o[t])).join("_").replace(/\s/g,"_")),a%2&&p.classList.add("drillDowner_even"),0===a&&p.classList.add("drillDowner_first_group");let u="";if(0===r){const e=String(t)[0]?.toUpperCase();e&&(u=`<span id="${this.options.idPrefix}az${e}"></span>`)}const _=p.insertCell(),g=r<e.length-1?`<span class="drillDowner_drill_icon drillDowner_drill_collapsed" data-rowid="${h}" data-level="${r}"></span>`:"";_.innerHTML=`${u}<span class="drillDowner_indent_${r}">${g}${0===r?`<b>${t}</b>`:t}</span>`,this._appendDataCells(p,c[0],c,r===e.length-1),this._buildFlatRows(c,e,r+1,{...o,[i]:t},s,l)}))}_appendDataCells(t,e,r,o){this.options.totals.forEach((o=>{const s=t.insertCell();s.className="drillDowner_num";const l=this._getColDecimals(o);if(r){const t=this._getColProperty(o,"subTotalBy");if(t){const e={};r.forEach((r=>{e[r[t]]=(e[r[t]]||0)+Number(r[o])})),s.innerHTML=Object.entries(e).map((([t,e])=>`${DrillDowner.formatNumber(e,l)} ${t}`)).join(", ")||"-"}else s.textContent=DrillDowner.formatNumber(r.reduce(((t,e)=>t+(Number(e[o])||0)),0),l)}else s.textContent=DrillDowner.formatNumber(e[o],l)})),this.options.columns.forEach((s=>{const l=t.insertCell();l.className=this._getColClass(s);let i="";r&&this._getColTogglesUp(s)?i=Array.from(new Set(r.map((t=>t[s])))).join(", "):r&&!o||(i=e[s]);const n=this._getColFormatter(s);l.innerHTML=n?n(i,e):i}))}_getColProperty(t,e,r=null){return this.options.colProperties[t]?.[e]??r}_getColDecimals(t){return this._getColProperty(t,"decimals",2)}_getColLabel(t){return this._getColProperty(t,"label",t.charAt(0).toUpperCase()+t.slice(1))}_getGroupIcon(t){return this._getColProperty(t,"icon","")}_getColClass(t){return this._getColProperty(t,"class","")}_getColLabelClass(t){return this._getColProperty(t,"labelClass","")}_getColTogglesUp(t){return this._getColProperty(t,"togglesUp",!1)}_getColFormatter(t){return this._getColProperty(t,"formatter",null)}_onDrillClick(t){const e=t.target,r=e.dataset.rowid,o=e.classList.contains("drillDowner_drill_expanded");e.classList.toggle("drillDowner_drill_expanded",!o),e.classList.toggle("drillDowner_drill_collapsed",o);const s=(t,e)=>{this.table.querySelectorAll(`tr[data-parent="${t}"]`).forEach((t=>{if(t.style.display=e?"":"none",!e){const e=t.querySelector(".drillDowner_drill_icon");e&&(e.classList.remove("drillDowner_drill_expanded"),e.classList.add("drillDowner_drill_collapsed")),s(t.id,!1)}}))};s(r,!o)}_onAZClick(){setTimeout((()=>window.scrollBy(0,-30)),1)}_renderAZBar(){if(!this.azBar||0===this.options.groupOrder.length)return void(this.azBar&&(this.azBar.innerHTML=""));const t=this.options.groupOrder[0],e=new Set(this.dataArr.map((e=>String(e[t]||"")[0]?.toUpperCase())));let r="";for(let t=65;t<=90;t++){const o=String.fromCharCode(t);r+=e.has(o)?`<div><a href="#${this.options.idPrefix}az${o}" class="drillDowner_az_link">${o}</a></div>`:`<div class="drillDowner_az_dimmed">${o}</div>`}this.azBar.innerHTML=r,this.azBar.querySelectorAll(".drillDowner_az_link").forEach((t=>t.onclick=()=>this._onAZClick()))}_calculateGrandTotals(){const t={};return this.options.totals.forEach((e=>{const r=this._getColProperty(e,"subTotalBy");if(r){const o={};this.dataArr.forEach((t=>{null!=t[e]&&(o[t[r]]=(o[t[r]]||0)+Number(t[e]))})),t[e]=o}else t[e]=this.dataArr.reduce(((t,r)=>t+(Number(r[e])||0)),0)})),t}_formatGrandTotal(t){const e=this.grandTotals[t],r=this._getColDecimals(t);return"object"!=typeof e?DrillDowner.formatNumber(e,r):Object.entries(e).map((([t,e])=>`${DrillDowner.formatNumber(e,r)} ${t}`)).join("<br>")||"-"}_sortAsc(t,e){return e?.length?t.sort(((t,r)=>{for(let o of e){const e=this._natSort(String(t[o]||""),String(r[o]||""));if(0!==e)return e}return 0})):t}static formatNumber(t,e){return null==t||isNaN(t)||""===t?t||"":Number(t).toLocaleString("en-US",{minimumFractionDigits:e,maximumFractionDigits:e})}_removeAllEventListeners(t){if(!t)return t;const e=t.cloneNode(!0);return t.parentNode.replaceChild(e,t),e}_generatePermutations(t){const e=[],r=(t,o=0)=>{if(o!==t.length-1)for(let e=o;e<t.length;e++)[t[o],t[e]]=[t[e],t[o]],r(t,o+1),[t[o],t[e]]=[t[e],t[o]];else e.push([...t])};return r(Array.from({length:t},((t,e)=>e))),e}}