class DrillDowner{constructor(t,e,o={}){this.container="string"==typeof t?document.querySelector(t):t,this.dataArr=e,this.options=Object.assign({columns:[],totals:[],colProperties:{},groupOrder:[],groupOrderCombinations:null,ledger:[],idPrefix:"drillDowner"+Math.random().toString(36).slice(2)+"_",azBarSelector:null,controlsSelector:null,showGrandTotals:!0},o),this.options.ledger&&!Array.isArray(this.options.ledger)&&(this.options.ledger=[this.options.ledger]),this.options.ledger=this.options.ledger||[],0===this.options.groupOrder.length&&this.options.ledger.length>0?this.activeLedgerIndex=0:this.activeLedgerIndex=-1,this.options.totals=this.options.totals||[],this.options.columns=this.options.columns||[],this._defaultColumns=[...this.options.columns],this.options.colProperties=this.options.colProperties||{},this.azBar=this.options.azBarSelector?"string"==typeof this.options.azBarSelector?document.querySelector(this.options.azBarSelector):this.options.azBarSelector:null,this.controls=this.options.controlsSelector?"string"==typeof this.options.controlsSelector?document.querySelector(this.options.controlsSelector):this.options.controlsSelector:null,this._natSort=new Intl.Collator("es-MX",{sensitivity:"base",numeric:!0,caseFirst:"false"}).compare,this.grandTotals=this._calculateGrandTotals(),this._onDrillClick=this._onDrillClick.bind(this),this._onAZClick=this._onAZClick.bind(this),this.render()}collapseToLevel(t=0){if(!this.container)return this;if(!this.options.groupOrder||0===this.options.groupOrder.length)return this._updateBreadcrumbArrows(0),this;(isNaN(t)||null==t||t<0)&&(t=0);const e=this.options.groupOrder.length-1;t>e&&(t=e);const o=this.container.querySelector("table.drillDowner_table");if(!o)return this._updateBreadcrumbArrows(t),this;return o.querySelectorAll("tbody tr").forEach((e=>{const o=+e.getAttribute("data-level");e.style.display=o>t?"none":"";e.querySelectorAll(".drillDowner_drill_icon").forEach((t=>{t.classList.remove("drillDowner_drill_expanded"),t.classList.add("drillDowner_drill_collapsed")}))})),this._updateBreadcrumbArrows(t),this}collapseAll(){return this.collapseToLevel(0),this}expandAll(){return this.collapseToLevel(this.options.groupOrder.length-1),this}changeGroupOrder(t){return-1!==this.activeLedgerIndex&&(this.options.columns=[...this._defaultColumns],this.activeLedgerIndex=-1),this.options.groupOrder=t,this.render(),this}destroy(){this.controls&&(this.controls=this._removeAllEventListeners(this.controls),this.controls.innerHTML=""),this.azBar&&(this.azBar=this._removeAllEventListeners(this.azBar),this.azBar.innerHTML=""),this.table&&(this.table=this._removeAllEventListeners(this.table)),this.container.innerHTML=""}render(){if(this.grandTotals=this._calculateGrandTotals(),0===this.options.groupOrder.length&&this.activeLedgerIndex>=0&&this.options.ledger[this.activeLedgerIndex]){const t=this.options.ledger[this.activeLedgerIndex];t.cols&&(this.options.columns=t.cols)}this.options.groupOrder.length>0&&(this.activeLedgerIndex=-1),this.controls&&(this.controls=this._removeAllEventListeners(this.controls)),this.azBar&&(this.azBar=this._removeAllEventListeners(this.azBar)),this.table&&(this.table=this._removeAllEventListeners(this.table)),this._renderControls(),this._renderAZBar(),this._renderTable(),this.options.groupOrder.length>0&&this.collapseToLevel(0)}getTable(){return this.container.querySelector("table.drillDowner_table")}_renderControls(){if(!this.controls)return;const t=this.options.idPrefix,e=[];if(this.options.groupOrder.length>0)this.options.groupOrder.forEach(((t,o)=>{const r=this._getColLabel(t),s=this._getGroupIcon(t);if(e.push(`\n                <button type="button" class="drillDowner_breadcrumb_item" data-level="${o}">\n                    <span>${s} ${r}</span>\n                </button>`),o<this.options.groupOrder.length-1){const t=this._getColLabel(this.options.groupOrder[o+1]);e.push(`\n                    <button type="button" class="drillDowner_breadcrumb_arrow drillDowner_collapsed"\n                         data-arrow-level="${o}"\n                         title="Click to expand to ${t} level">\n                        <span class="drillDowner_arrow_icon">▶</span>\n                    </button>`)}}));else if(this.activeLedgerIndex>=0&&this.options.ledger[this.activeLedgerIndex]){const t=this.options.ledger[this.activeLedgerIndex].label;e.push(`<span class="drillDowner_breadcrumb_item" style="cursor:default"><b>${t}</b></span>`)}const o=e.join("");let r="",s=!0;if(this.options.groupOrderCombinations)this.options.groupOrderCombinations.forEach(((t,e)=>{const o=t.map((t=>this._getColLabel(t)));r+=`<option value="${e}">${o.join(" → ")}</option>`}));else{const t=this.options.groupOrder.length;if(t>0)if(2===t){const t=this.options.groupOrder.map((t=>this._getColLabel(t)));r=`\n                    <option value="0,1">${t[0]} → ${t[1]}</option>\n                    <option value="1,0">${t[1]} → ${t[0]}</option>`}else if(3===t){const t=this.options.groupOrder.map((t=>this._getColLabel(t)));r=`\n                    <option value="0,1,2">${t[0]} → ${t[1]} → ${t[2]}</option>\n                    <option value="0,2,1">${t[0]} → ${t[2]} → ${t[1]}</option>\n                    <option value="1,0,2">${t[1]} → ${t[0]} → ${t[2]}</option>\n                    <option value="1,2,0">${t[1]} → ${t[2]} → ${t[0]}</option>\n                    <option value="2,0,1">${t[2]} → ${t[0]} → ${t[1]}</option>\n                    <option value="2,1,0">${t[2]} → ${t[1]} → ${t[0]}</option>`}else if(t>1){const e=this._generatePermutations(t).slice(0,9),o=this.options.groupOrder.map((t=>this._getColLabel(t)));e.forEach((t=>{const e=t.map((t=>o[t])),s=t.join(",");r+=`<option value="${s}">${e.join(" → ")}</option>`}))}}this.options.ledger.length>0&&this.options.ledger.forEach(((t,e)=>{const o=this.activeLedgerIndex===e?"selected":"";r+=`<option value="__LEDGER_${e}__" ${o}>${t.label}</option>`})),0===this.options.groupOrder.length&&0===this.options.ledger.length&&(s=!1),1===this.options.groupOrder.length&&0===this.options.ledger.length&&(s=!1);const i=s?`\n        <div class="drillDowner_grouping_controls">\n            <div class="drillDowner_control_group">\n                <span class="drillDowner_control_label">Group by:</span>\n                <select class="drillDowner_modern_select" id="${t}grouporder">\n                    ${r}\n                </select>\n            </div>\n        </div>`:"";this.controls.innerHTML=`\n        <div class="drillDowner_controls_container">\n            <div class="drillDowner_breadcrumb_nav">${o}</div>\n            ${i}\n        </div>`;this.controls.querySelectorAll(".drillDowner_breadcrumb_item").forEach((t=>{t.dataset.level&&t.addEventListener("click",(t=>this.collapseToLevel(parseInt(t.currentTarget.dataset.level))))}));if(this.controls.querySelectorAll(".drillDowner_breadcrumb_arrow").forEach((t=>{t.addEventListener("click",(t=>{const e=parseInt(t.currentTarget.dataset.arrowLevel),o=t.currentTarget.classList.contains("drillDowner_expanded");this.collapseToLevel(o?e:e+1)}))})),s){const e=this.controls.querySelector("#"+t+"grouporder");e&&e.addEventListener("change",(t=>{const e=t.target.value;if(e.startsWith("__LEDGER_")){const t=parseInt(e.replace("__LEDGER_","").replace("__",""));this.options.groupOrder=[],this.activeLedgerIndex=t,this.render()}else if(this.options.groupOrderCombinations){const t=parseInt(e);t>=0&&t<this.options.groupOrderCombinations.length&&this.changeGroupOrder(this.options.groupOrderCombinations[t])}else{const t=e.split(",").map((t=>parseInt(t)));if(this.options.groupOrder.length>0){const e=t.map((t=>this.options.groupOrder[t]));this.changeGroupOrder(e)}}}))}this._updateBreadcrumbArrows(0)}_updateBreadcrumbArrows(t=0){if(!this.controls||0===this.options.groupOrder.length)return;this.controls.querySelectorAll(".drillDowner_breadcrumb_arrow").forEach(((e,o)=>{const r=o+1;if(r<this.options.groupOrder.length){const o=this._getColLabel(this.options.groupOrder[r]);e.classList.remove("drillDowner_expanded","drillDowner_collapsed"),t>=r?(e.classList.add("drillDowner_expanded"),e.setAttribute("title",`Collapsa a ${o} level`)):(e.classList.add("drillDowner_collapsed"),e.setAttribute("title",`Expande a ${o} level`))}}))}_generatePermutations(t){if(t<=1)return 0===t?[]:[[0]];const e=[];return function t(o,r=0){if(r!==o.length-1)for(let e=r;e<o.length;e++)[o[r],o[e]]=[o[e],o[r]],t(o,r+1),[o[r],o[e]]=[o[e],o[r]];else e.push([...o])}(Array.from({length:t},((t,e)=>e))),e}_renderAZBar(){if(!this.azBar)return;if(0===this.options.groupOrder.length)return void(this.azBar.innerHTML="");const t=this._getGroupCol(0),e=new Set(this.dataArr.map((e=>(e[t]||"")[0]?.toUpperCase())));let o="";for(let t=65;t<=90;t++){const r=String.fromCharCode(t),s=`${this.options.idPrefix}az${r}`;e.has(r)?o+=`<div><a href="#${s}" class="drillDowner_az_link ${this.options.idPrefix}az_link">${r}</a></div>`:o+=`<div class="drillDowner_az_dimmed">${r}</div>`}this.azBar=this._removeAllEventListeners(this.azBar),this.azBar.innerHTML=o;this.azBar.querySelectorAll("."+this.options.idPrefix+"az_link").forEach((t=>t.addEventListener("click",this._onAZClick)))}_renderTable(){this.container.innerHTML="";const t=[...this.options.groupOrder.length>0?["Item"]:["#"],...this.options.totals.map((t=>{const e=this._getColProperty(t,"subTotalBy");if(e){return`${this._getColLabel(t)} (${this._getColLabel(e)})`}return this._getColLabel(t)})),...this.options.columns.map((t=>this._getColLabel(t)))],e=document.createElement("thead"),o=document.createElement("tr");t.forEach(((t,e)=>{let r="",s=t;if(0===e);else if(e<=this.options.totals.length){const o=this.options.totals[e-1];if(r=this._getColLabelClass(o),this.options.showGrandTotals){s=`${t}<br><small>${this._formatGrandTotal(o)}</small>`,r+=" drillDownerThTotal"}}else{const t=this.options.columns[e-this.options.totals.length-1];r=this._getColLabelClass(t)}const i=document.createElement("th");i.className=r,i.innerHTML=s,o.appendChild(i)})),e.appendChild(o);const r=[];this.azAnchoredLetters=new Set;const s=document.createElement("tbody");if(0===this.options.groupOrder.length&&this.activeLedgerIndex>=0&&this.options.ledger[this.activeLedgerIndex]){const t=this.options.ledger[this.activeLedgerIndex];this._sortAsc(this.dataArr,t.sort),this._buildNoGroupRows(this.dataArr,r)}else this._sortAsc(this.dataArr,this.options.groupOrder),this._buildFlatRows(this.dataArr,this.options.groupOrder,0,{},r);r.forEach((t=>s.appendChild(t)));let i=null;if(this.options.showGrandTotals){i=document.createElement("tfoot");const e=document.createElement("tr");t.forEach(((t,o)=>{let r,s;if(0===o)s="<b>Total</b>",r=" drillDowner_right";else if(o<=this.options.totals.length){const t=this.options.totals[o-1];r=this._getColLabelClass(t)+" drillDowner_num drillDownerTfootTotal",s=`${this._formatGrandTotal(t)}`}else{const t=this.options.columns[o-this.options.totals.length-1];r=this._getColLabelClass(t),s=""}const i=document.createElement("td");i.className=r,i.innerHTML=s,e.appendChild(i)})),i.appendChild(e)}const l=document.createElement("table");l.className="drillDowner_table",l.appendChild(e),l.appendChild(s),this.options.showGrandTotals&&i&&l.appendChild(i),this.container.appendChild(l),l.querySelectorAll("."+this.options.idPrefix+"drill_icon").forEach((t=>t.addEventListener("click",this._onDrillClick))),this.table=l}_buildNoGroupRows(t,e){t.forEach(((t,o)=>{const r=document.createElement("tr");r.className=o%2==1?"drillDowner_even":"";const s=document.createElement("td");s.innerHTML=`<span class="drillDowner_indent_0">${o+1}</span>`,r.appendChild(s),this._appendDataCells(r,t,null,!0),e.push(r)}))}_buildFlatRows(t,e,o,r,s){if(o>=e.length)return;const i=this._getGroupCol(o),l=this._getGroupKey(o),n={};t.forEach((t=>{const e=t[i];e in n||(n[e]=[]),n[e].push(t)})),Object.keys(n).forEach(((t,a)=>{const d=n[t],h=e.slice(0,o+1).map(((e,s)=>r[e]||(s===o?t:""))),c=this.options.idPrefix+"row_"+h.join("_").replace(/\s/g,"_"),p=0===o?"":this.options.idPrefix+"row_"+e.slice(0,o).map((t=>r[t])).join("_").replace(/\s/g,"_"),u=document.createElement("tr");u.id=c,u.setAttribute("data-level",o),u.setAttribute("data-parent",p),u.classList.add("drillDowner_row_"+l),a%2==1&&u.classList.add("drillDowner_even"),0===a&&u.classList.add("drillDowner_first_group");let _="";if(0===o){const e=null==t?"":String(t);if(e.length>0){const t=e.charAt(0).toUpperCase();if(!this.azAnchoredLetters.has(t)){_=`<span id="${this.options.idPrefix+"az"+t}" class="drillDowner_az_anchor"></span>`,this.azAnchoredLetters.add(t)}}}let g,m="";o<e.length-1&&(m=`<span class="${this.options.idPrefix}drill_icon drillDowner_drill_icon drillDowner_drill_collapsed" data-rowid="${c}" data-level="${o}"></span>`),g=0===o?`<span class="drillDowner_indent_${o}">${m}<b>${t}</b></span>`:`<span class="drillDowner_indent_${o}">${m}${t}</span>`;const b=document.createElement("td");b.innerHTML=_+g,u.appendChild(b);const f=o===e.length-1&&1===d.length,C=d.length>0?d[0]:{};this._appendDataCells(u,C,d,f),s.push(u),o<e.length-1&&this._buildFlatRows(d,e,o+1,{...r,[i]:t},s)}))}_appendDataCells(t,e,o=null,r=!1){this.options.totals.forEach((r=>{const s=this._getColDecimals(r),i=this._getColProperty(r,"subTotalBy"),l=document.createElement("td");if(l.className="drillDowner_num",o)if(i){const t={};o.forEach((e=>{const o=e[i];null!=e[r]&&null!==o&&(t[o]=(Number(t[o])||0)+Number(e[r]))})),l.innerHTML=Object.entries(t).map((([t,e])=>DrillDowner.formatNumber(e,s)+" "+t)).join(", ")||"-"}else{const t=o.reduce(((t,e)=>t+(Number(e[r])||0)),0);l.innerHTML=DrillDowner.formatNumber(t,s)}else{const t=Number(e[r])||0;l.innerHTML=DrillDowner.formatNumber(t,s)}t.appendChild(l)})),this.options.columns.forEach((s=>{const i=this._getColTogglesUp(s),l=this._getColClass(s),n=this._getColFormatter(s),a=document.createElement("td");if(a.className=l,o&&i){const t=new Set;for(const e of o){let o=s in e?e[s]:"";n&&(o=n(o,e)),o&&""!==o&&t.add(o)}a.innerHTML=Array.from(t).join(", ")}else if(!o||r){let t=s in e?e[s]:"";n&&(t=n(t,e)),a.innerHTML=t}else a.innerHTML="";t.appendChild(a)}))}_onDrillClick(t){const e=t.target,o=e.dataset.rowid,r=+e.dataset.level,s=e.closest("table").querySelectorAll("tbody tr");e.classList.contains("drillDowner_drill_collapsed")?(e.classList.remove("drillDowner_drill_collapsed"),e.classList.add("drillDowner_drill_expanded"),this._setChildrenVisible(o,r,!0,s)):(e.classList.remove("drillDowner_drill_expanded"),e.classList.add("drillDowner_drill_collapsed"),this._setChildrenVisible(o,r,!1,s))}_setChildrenVisible(t,e,o,r){r.forEach((e=>{e.getAttribute("data-parent")===t&&(o?e.style.display="":(e.style.display="none",e.querySelectorAll(".drillDowner_drill_icon").forEach((t=>{t.classList.remove("drillDowner_drill_expanded"),t.classList.add("drillDowner_drill_collapsed")})),this._setChildrenVisible(e.id,+e.getAttribute("data-level"),!1,r)))}))}_onAZClick(){setTimeout((function(){window.scrollBy(0,-30)}),1)}static formatNumber(t,e){return""===t||null===t?"":isNaN(t)?t:Number(t).toLocaleString("en-US",{minimumFractionDigits:e,maximumFractionDigits:e})}_sortAsc(t,e){if(!e||0===e.length)return t;const o=this._natSort;return t.sort(((t,r)=>{for(let s of e){const e=(t[s]??"").toString(),i=(r[s]??"").toString(),l=o(e,i);if(0!==l)return l}return 0})),t}_calculateGrandTotals(){const t={};return this.options.totals.forEach((e=>{const o=this._getColProperty(e,"subTotalBy");if(o){const r={};this.dataArr.forEach((t=>{const s=t[o];null!=t[e]&&null!==s&&(r[s]=(r[s]||0)+t[e])})),t[e]=r}else t[e]=this.dataArr.reduce(((t,o)=>t+(o[e]||0)),0)})),t}_formatGrandTotal(t){const e=this._getColDecimals(t),o=this._getColProperty(t,"subTotalBy"),r=this.grandTotals[t];if(o){return Object.entries(r).map((([t,o])=>DrillDowner.formatNumber(o,e)+" "+t)).join("<br>")||"-"}return DrillDowner.formatNumber(r,e)}_getColProperty(t,e,o=null){return this.options.colProperties[t]&&void 0!==this.options.colProperties[t][e]?this.options.colProperties[t][e]:o}_getColDecimals(t){return this._getColProperty(t,"decimals",2)}_getColLabel(t){return this._getColProperty(t,"label",t.charAt(0).toUpperCase()+t.slice(1))}_getGroupIcon(t){return this._getColProperty(t,"icon","")}_getColClass(t){return this._getColProperty(t,"class","")}_getColLabelClass(t){return this._getColProperty(t,"labelClass","")}_getColKey(t){return this._getColProperty(t,"key",t)}_getColTogglesUp(t){return this._getColProperty(t,"togglesUp",!1)}_getColFormatter(t){return this._getColProperty(t,"formatter",null)}_getGroupCol(t){return this.options.groupOrder[t]}_getGroupKey(t){return this._getColKey(this._getGroupCol(t))}_removeAllEventListeners(t){if(!t)return;const e=t.cloneNode(!0);return t.parentNode?(t.parentNode.replaceChild(e,t),e):t}}