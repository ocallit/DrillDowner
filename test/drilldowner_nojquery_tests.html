<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DrillDownerNoJquery QUnit Test Suite</title>

    <!-- QUnit CSS and JS -->
    <link rel="stylesheet" href="https://code.jquery.com/qunit/qunit-2.19.4.css">
    <script src="https://code.jquery.com/qunit/qunit-2.19.4.js"></script>

    <!-- jQuery (only for QUnit test helpers, not for DrillDownerNoJquery) -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!-- DrillDowner files - these would need to be included in your test environment -->
    <link href="../src/drilldowner.css" rel="stylesheet"  type="text/css"/>
    <script src="../src/DrillDownerNoJquery.js"></script>
</head>
<body>
<div id="qunit"></div>
<div id="qunit-fixture">
    <!-- Test containers -->
    <div id="test-container"></div>
    <div id="test-controls"></div>
    <div id="test-azbar"></div>
</div>

<script>
    // Test data
    const testData = [
        {p:"Zeta", c:"Naranja", w:"W2", rolls:32, quantity:72, unidades:"Kg", sale:false, slow:false, superslow:false, customFlag:true, status:"pending", priority:3},
        {p:"Alpha", c:"Rojo", w:"W1", rolls:12, quantity:122, unidades:"Kg", sale:true, slow:false, superslow:false, customFlag:true, status:"completed", priority:1},
        {p:"Alpha", c:"Rojo", w:"W2", rolls:2, quantity:22, unidades:"Kg", sale:false, superslow:false, status:"active", priority:2},
        {p:"Alpha", c:"Azul", w:"W1", rolls:3, quantity:10, unidades:"Kg", sale:false, slow:false, superslow:true, customFlag:false, status:"pending", priority:1},
        {p:"Beta", c:"Verde", w:"W1", rolls:4, quantity:30, unidades:"m", sale:false, slow:false, superslow:false, customFlag:true, status:"completed", priority:2},
        {p:"Gamma", c:"Rojo", w:"W2", rolls:1, quantity:15, unidades:"m", sale:true, slow:false, superslow:false, customFlag:false, status:"active", priority:3},
        {p:"Delta", c:"Amarillo", w:"W3", rolls:7, quantity:54, unidades:"Kg", sale:false, slow:true, superslow:true, customFlag:false, status:"pending", priority:1},
        {p:"Zeta", c:"Naranja", w:"W1", rolls:3, quantity:70, unidades:"Kg", sale:false, slow:false, superslow:false, customFlag:true, status:"completed", priority:2},
        {p:"Zeta", c:"Naranja2", w:"W1", rolls:3, quantity:70, unidades:"m", sale:false, slow:false, superslow:false, customFlag:true, status:"completed", priority:2},
    ];

    const testColProperties = {
        "p": {
            label: "Producto",
            key: "product",
            labelClass: "header_producto"
        },
        "c": {
            label: "Color",
            key: "color",
            labelClass: "header_color"
        },
        "w": {
            label: "Almac√©n",
            key: "warehouse",
            labelClass: "header_almacen"
        },
        "rolls": {
            label: "Rollos",
            decimals: 0,
            class: "lupa_num"
        },
        "quantity": {
            label: "Cantidad",
            decimals: 2,
            subTotalBy: "unidades",
            class: "lupa_num"
        },
        "unidades": {
            label: "Kg/m",
            togglesUp: true,
            class: "",
            formatter: function(value, row) {
                return value || "";
            }
        },
        "slow": {
            label: "Lento",
            togglesUp: true,
            class: "lupa_status_slow",
            formatter: function(value, row) {
                return value ? "‚óè" : "";
            }
        },
        "sale": {
            label: "En Oferta",
            togglesUp: true,
            class: "lupa_status_sale"
        },
        "superslow": {
            label: "Muy Lento",
            togglesUp: true,
            class: "lupa_status_superslow"
        },
        "status": {
            label: "Estado",
            class: "",
            formatter: function(value, row) {
                const statusMap = {
                    "pending": "‚è≥ Pendiente",
                    "active": "üîÑ Activo",
                    "completed": "‚úÖ Completado"
                };
                return statusMap[value] || value;
            }
        },
        "priority": {
            label: "Prioridad",
            class: "",
            formatter: function(value, row) {
                const stars = "‚òÖ".repeat(value);
                const color = value === 1 ? 'color: red' : value === 2 ? 'color: orange' : 'color: gray';
                return `<span style="${color}">${stars}</span>`;
            }
        }
    };

    // QUnit Tests
    QUnit.module('DrillDownerNoJquery Initialization', function() {
        QUnit.test('Basic initialization with minimal options', function(assert) {
            const container = '#test-container';
            document.querySelector(container).innerHTML = '';

            const drillDowner = new DrillDownerNoJquery(container, testData, {
                groupOrder: ["p"],
                columns: ["status"],
                totals: ["rolls"]
            });

            assert.ok(drillDowner instanceof DrillDownerNoJquery, 'DrillDownerNoJquery instance created');
            assert.ok(document.querySelector(container + ' table.drillDowner_table'), 'Table is rendered');
            assert.ok(drillDowner.options.idPrefix.length > 0, 'ID prefix is generated');

            drillDowner.destroy();
        });

        QUnit.test('Initialization with all options', function(assert) {
            const container = '#test-container';
            const controls = '#test-controls';
            const azbar = '#test-azbar';

            document.querySelector(container).innerHTML = '';
            document.querySelector(controls).innerHTML = '';
            document.querySelector(azbar).innerHTML = '';

            const drillDowner = new DrillDownerNoJquery(container, testData, {
                groupOrder: ["p", "c", "w"],
                columns: ["status", "priority"],
                totals: ["rolls", "quantity"],
                colProperties: testColProperties,
                azBarSelector: azbar,
                controlsSelector: controls
            });

            assert.ok(drillDowner instanceof DrillDownerNoJquery, 'DrillDownerNoJquery instance created');
            assert.ok(document.querySelector(container + ' table.drillDowner_table'), 'Table is rendered');
            assert.ok(document.querySelector(controls + ' .drillDowner_controls_container'), 'Controls are rendered');
            assert.ok(document.querySelector(azbar + ' .drillDowner_az_link'), 'AZ bar is rendered');

            drillDowner.destroy();
        });

        QUnit.test('Initialization with empty data', function(assert) {
            const container = '#test-container';
            document.querySelector(container).innerHTML = '';

            const drillDowner = new DrillDownerNoJquery(container, [], {
                groupOrder: ["p"],
                columns: ["status"],
                totals: ["rolls"]
            });

            assert.ok(drillDowner instanceof DrillDownerNoJquery, 'DrillDownerNoJquery instance created with empty data');
            assert.ok(document.querySelector(container + ' table.drillDowner_table'), 'Table is rendered even with empty data');

            drillDowner.destroy();
        });
    });

    QUnit.module('DrillDownerNoJquery Table Rendering', function() {
        QUnit.test('Table structure is correct', function(assert) {
            const container = '#test-container';
            document.querySelector(container).innerHTML = '';

            const drillDowner = new DrillDownerNoJquery(container, testData, {
                groupOrder: ["p", "c"],
                columns: ["status"],
                totals: ["rolls"],
                colProperties: testColProperties
            });

            const table = document.querySelector(container + ' table.drillDowner_table');
            assert.ok(table, 'Table exists');

            const thead = table.querySelector('thead');
            assert.ok(thead, 'Table header exists');

            const tbody = table.querySelector('tbody');
            assert.ok(tbody, 'Table body exists');

            const headerCount = thead.querySelectorAll('th').length;
            assert.equal(headerCount, 3, 'Correct number of headers (Item + 1 total + 1 column)');

            drillDowner.destroy();
        });

        QUnit.test('Drill icons are present at appropriate levels', function(assert) {
            const container = '#test-container';
            document.querySelector(container).innerHTML = '';

            const drillDowner = new DrillDownerNoJquery(container, testData, {
                groupOrder: ["p", "c"],
                columns: ["status"],
                totals: ["rolls"]
            });

            const level0Rows = document.querySelectorAll(container + ' tr[data-level="0"]');
            const level1Rows = document.querySelectorAll(container + ' tr[data-level="1"]');

            assert.ok(level0Rows.length > 0, 'Level 0 rows exist');
            assert.ok(level1Rows.length > 0, 'Level 1 rows exist');

            // Level 0 should have drill icons (can drill to level 1)
            let level0DrillIcons = 0;
            level0Rows.forEach(row => {
                level0DrillIcons += row.querySelectorAll('.drillDowner_drill_icon').length;
            });
            assert.ok(level0DrillIcons > 0, 'Level 0 rows have drill icons');

            // Level 1 should not have drill icons (last level)
            let level1DrillIcons = 0;
            level1Rows.forEach(row => {
                level1DrillIcons += row.querySelectorAll('.drillDowner_drill_icon').length;
            });
            assert.equal(level1DrillIcons, 0, 'Level 1 rows do not have drill icons');

            drillDowner.destroy();
        });

        QUnit.test('Totals are calculated correctly', function(assert) {
            const container = '#test-container';
            document.querySelector(container).innerHTML = '';

            const drillDowner = new DrillDownerNoJquery(container, testData, {
                groupOrder: ["p"],
                columns: [],
                totals: ["rolls"],
                colProperties: testColProperties
            });

            // Check that totals are displayed in the table
            const table = document.querySelector(container + ' table.drillDowner_table');
            const totalCells = table.querySelectorAll('td.drillDowner_num');

            assert.ok(totalCells.length > 0, 'Total cells are present');

            // Verify at least one total is a number
            let foundNumericTotal = false;
            totalCells.forEach(cell => {
                const text = cell.textContent.trim();
                if (!isNaN(parseFloat(text))) {
                    foundNumericTotal = true;
                }
            });
            assert.ok(foundNumericTotal, 'At least one numeric total found');

            drillDowner.destroy();
        });
    });

    QUnit.module('DrillDownerNoJquery Collapse/Expand Functionality', function() {
        QUnit.test('collapseToLevel works correctly', function(assert) {
            const container = '#test-container';
            document.querySelector(container).innerHTML = '';

            const drillDowner = new DrillDownerNoJquery(container, testData, {
                groupOrder: ["p", "c", "w"],
                columns: ["status"],
                totals: ["rolls"]
            });

            // Initially collapsed to level 0
            let visibleRows = Array.from(document.querySelectorAll(container + ' tbody tr')).filter(row => 
                window.getComputedStyle(row).display !== 'none').length;
            let level0Rows = document.querySelectorAll(container + ' tr[data-level="0"]').length;
            assert.equal(visibleRows, level0Rows, 'Initially only level 0 rows are visible');

            // Expand to level 1
            drillDowner.collapseToLevel(1);
            visibleRows = Array.from(document.querySelectorAll(container + ' tbody tr')).filter(row => 
                window.getComputedStyle(row).display !== 'none').length;
            level0Rows = document.querySelectorAll(container + ' tr[data-level="0"]').length;
            const level1Rows = document.querySelectorAll(container + ' tr[data-level="1"]').length;
            assert.equal(visibleRows, level0Rows + level1Rows, 'Level 0 and 1 rows are visible');

            // Collapse back to level 0
            drillDowner.collapseToLevel(0);
            visibleRows = Array.from(document.querySelectorAll(container + ' tbody tr')).filter(row => 
                window.getComputedStyle(row).display !== 'none').length;
            level0Rows = document.querySelectorAll(container + ' tr[data-level="0"]').length;
            assert.equal(visibleRows, level0Rows, 'Back to only level 0 rows visible');

            drillDowner.destroy();
        });

        QUnit.test('collapseAll and expandAll work correctly', function(assert) {
            const container = '#test-container';
            document.querySelector(container).innerHTML = '';

            const drillDowner = new DrillDownerNoJquery(container, testData, {
                groupOrder: ["p", "c", "w"],
                columns: ["status"],
                totals: ["rolls"]
            });

            // Test expandAll
            drillDowner.expandAll();
            const allVisibleRows = Array.from(document.querySelectorAll(container + ' tbody tr')).filter(row => 
                window.getComputedStyle(row).display !== 'none').length;
            const totalRows = document.querySelectorAll(container + ' tbody tr').length;
            assert.equal(allVisibleRows, totalRows, 'expandAll shows all rows');

            // Test collapseAll
            drillDowner.collapseAll();
            const visibleRows = Array.from(document.querySelectorAll(container + ' tbody tr')).filter(row => 
                window.getComputedStyle(row).display !== 'none').length;
            const level0Rows = document.querySelectorAll(container + ' tr[data-level="0"]').length;
            assert.equal(visibleRows, level0Rows, 'collapseAll shows only level 0 rows');

            drillDowner.destroy();
        });

        QUnit.test('Individual drill click functionality', function(assert) {
            const container = '#test-container';
            document.querySelector(container).innerHTML = '';

            const drillDowner = new DrillDownerNoJquery(container, testData, {
                groupOrder: ["p", "c"],
                columns: ["status"],
                totals: ["rolls"]
            });

            // Find the first drill icon
            const firstDrillIcon = document.querySelector(container + ' .drillDowner_drill_icon');
            assert.ok(firstDrillIcon, 'Drill icon found');
            assert.ok(firstDrillIcon.classList.contains('drillDowner_drill_collapsed'), 'Initially collapsed');

            // Simulate click
            firstDrillIcon.click();

            // Check if it expanded
            assert.ok(firstDrillIcon.classList.contains('drillDowner_drill_expanded'), 'Icon is now expanded');

            // Click again to collapse
            firstDrillIcon.click();
            assert.ok(firstDrillIcon.classList.contains('drillDowner_drill_collapsed'), 'Icon is collapsed again');

            drillDowner.destroy();
        });
    });

    QUnit.module('DrillDownerNoJquery Controls', function() {
        QUnit.test('Controls render with breadcrumbs', function(assert) {
            const container = '#test-container';
            const controls = '#test-controls';
            document.querySelector(container).innerHTML = '';
            document.querySelector(controls).innerHTML = '';

            const drillDowner = new DrillDownerNoJquery(container, testData, {
                groupOrder: ["p", "c", "w"],
                columns: ["status"],
                totals: ["rolls"],
                colProperties: testColProperties,
                controlsSelector: controls
            });

            const breadcrumbs = document.querySelectorAll(controls + ' .drillDowner_breadcrumb_item');
            assert.equal(breadcrumbs.length, 3, 'Three breadcrumb items for three group levels');

            const arrows = document.querySelectorAll(controls + ' .drillDowner_breadcrumb_arrow');
            assert.equal(arrows.length, 2, 'Two arrows between three levels');

            drillDowner.destroy();
        });

        QUnit.test('Breadcrumb clicks work', function(assert) {
            const container = '#test-container';
            const controls = '#test-controls';
            document.querySelector(container).innerHTML = '';
            document.querySelector(controls).innerHTML = '';

            const drillDowner = new DrillDownerNoJquery(container, testData, {
                groupOrder: ["p", "c", "w"],
                columns: ["status"],
                totals: ["rolls"],
                controlsSelector: controls
            });

            // Click on level 1 breadcrumb
            const level1Breadcrumb = document.querySelector(controls + ' .drillDowner_breadcrumb_item[data-level="1"]');
            assert.ok(level1Breadcrumb, 'Level 1 breadcrumb found');

            level1Breadcrumb.click();

            // Check if view expanded to level 1
            const visibleRows = Array.from(document.querySelectorAll(container + ' tbody tr')).filter(row => 
                window.getComputedStyle(row).display !== 'none').length;
            const level0And1Rows = document.querySelectorAll(container + ' tr[data-level="0"], ' + container + ' tr[data-level="1"]').length;
            assert.ok(visibleRows >= level0And1Rows, 'Breadcrumb click expanded view');

            drillDowner.destroy();
        });

        QUnit.test('Group order selector works', function(assert) {
            const container = '#test-container';
            const controls = '#test-controls';
            document.querySelector(container).innerHTML = '';
            document.querySelector(controls).innerHTML = '';

            const drillDowner = new DrillDownerNoJquery(container, testData, {
                groupOrder: ["p", "c", "w"],
                columns: ["status"],
                totals: ["rolls"],
                colProperties: testColProperties,
                controlsSelector: controls
            });

            const select = document.querySelector(controls + ' select');
            if (select) {
                // Change to a different grouping order
                select.value = '1,0,2';
                const event = new Event('change');
                select.dispatchEvent(event);

                // Verify the order changed
                assert.deepEqual(drillDowner.options.groupOrder, ['c', 'p', 'w'], 'Group order changed correctly');
            } else {
                assert.ok(true, 'No group selector (acceptable for some configurations)');
            }

            drillDowner.destroy();
        });
    });

    QUnit.module('DrillDownerNoJquery AZ Bar', function() {
        QUnit.test('AZ bar renders correctly', function(assert) {
            const container = '#test-container';
            const azbar = '#test-azbar';
            document.querySelector(container).innerHTML = '';
            document.querySelector(azbar).innerHTML = '';

            const drillDowner = new DrillDownerNoJquery(container, testData, {
                groupOrder: ["p"],
                columns: ["status"],
                totals: ["rolls"],
                azBarSelector: azbar
            });

            const azLinks = document.querySelectorAll(azbar + ' .drillDowner_az_link');
            const azDimmed = document.querySelectorAll(azbar + ' .drillDowner_az_dimmed');

            assert.ok(azLinks.length > 0, 'Active AZ links found');
            assert.ok(azDimmed.length > 0, 'Dimmed AZ letters found');
            assert.equal(azLinks.length + azDimmed.length, 26, 'All 26 letters present');

            drillDowner.destroy();
        });

        QUnit.test('AZ bar shows correct active letters', function(assert) {
            const container = '#test-container';
            const azbar = '#test-azbar';
            document.querySelector(container).innerHTML = '';
            document.querySelector(azbar).innerHTML = '';

            const drillDowner = new DrillDownerNoJquery(container, testData, {
                groupOrder: ["p"],
                columns: ["status"],
                totals: ["rolls"],
                azBarSelector: azbar
            });

            // Check that letters corresponding to our test data are active
            const expectedActiveLetters = ['A', 'B', 'D', 'G', 'Z']; // Alpha, Beta, Delta, Gamma, Zeta

            expectedActiveLetters.forEach(letter => {
                const links = Array.from(document.querySelectorAll(azbar + ' .drillDowner_az_link'))
                    .filter(link => link.textContent === letter);
                assert.ok(links.length > 0, `Letter ${letter} is active in AZ bar`);
            });

            drillDowner.destroy();
        });
    });

    QUnit.module('DrillDownerNoJquery Column Properties', function() {
        QUnit.test('Column labels are applied correctly', function(assert) {
            const container = '#test-container';
            document.querySelector(container).innerHTML = '';

            const drillDowner = new DrillDownerNoJquery(container, testData, {
                groupOrder: ["p"],
                columns: ["status"],
                totals: ["rolls"],
                colProperties: testColProperties,
                showGrandTotals: false // Disable grand totals for cleaner header text testing
            });

            const headers = document.querySelectorAll(container + ' thead th');
            const headerTexts = Array.from(headers).map(header => header.textContent);

            assert.ok(headerTexts.includes('Rollos'), 'Custom label for rolls column applied');
            assert.ok(headerTexts.includes('Estado'), 'Custom label for status column applied');

            drillDowner.destroy();
        });

        QUnit.test('Column formatters work correctly', function(assert) {
            const container = '#test-container';
            document.querySelector(container).innerHTML = '';

            const drillDowner = new DrillDownerNoJquery(container, testData, {
                groupOrder: ["p", "c"],
                columns: ["status", "priority"],
                totals: [],
                colProperties: testColProperties
            });

            drillDowner.expandAll();

            // Check for formatted status values
            const statusCells = Array.from(document.querySelectorAll(container + ' tbody tr[data-level="1"] td'))
                .filter(cell => cell.textContent.includes('‚è≥') || cell.textContent.includes('üîÑ') || cell.textContent.includes('‚úÖ'));
            assert.ok(statusCells.length > 0, 'Status formatter applied correctly');

            // Check for formatted priority values (stars)
            const priorityCells = Array.from(document.querySelectorAll(container + ' tbody tr[data-level="1"] td'))
                .filter(cell => cell.textContent.includes('‚òÖ'));
            assert.ok(priorityCells.length > 0, 'Priority formatter applied correctly');

            drillDowner.destroy();
        });

        QUnit.test('togglesUp property works correctly', function(assert) {
            const container = '#test-container';
            document.querySelector(container).innerHTML = '';

            const drillDowner = new DrillDownerNoJquery(container, testData, {
                groupOrder: ["p"],
                columns: ["unidades", "slow"],
                totals: [],
                colProperties: testColProperties
            });

            // Check that togglesUp columns show combined values
            const unidadesCells = Array.from(document.querySelectorAll(container + ' tbody td'))
                .filter(cell => cell.textContent.includes('Kg') || cell.textContent.includes('m'));
            assert.ok(unidadesCells.length > 0, 'togglesUp columns show aggregated values');

            drillDowner.destroy();
        });
    });

    QUnit.module('DrillDownerNoJquery Edge Cases', function() {
        QUnit.test('Handles invalid collapse levels', function(assert) {
            const container = '#test-container';
            document.querySelector(container).innerHTML = '';

            const drillDowner = new DrillDownerNoJquery(container, testData, {
                groupOrder: ["p", "c"],
                columns: ["status"],
                totals: ["rolls"]
            });

            // Test negative level
            drillDowner.collapseToLevel(-1);
            let visibleRows = Array.from(document.querySelectorAll(container + ' tbody tr')).filter(row => 
                window.getComputedStyle(row).display !== 'none').length;
            let level0Rows = document.querySelectorAll(container + ' tr[data-level="0"]').length;
            assert.equal(visibleRows, level0Rows, 'Negative level defaults to 0');

            // Test level beyond available
            drillDowner.collapseToLevel(10);
            const allRows = document.querySelectorAll(container + ' tbody tr').length;
            visibleRows = Array.from(document.querySelectorAll(container + ' tbody tr')).filter(row => 
                window.getComputedStyle(row).display !== 'none').length;
            assert.equal(visibleRows, allRows, 'Excessive level shows all rows');

            // Test null/undefined level
            drillDowner.collapseToLevel(null);
            visibleRows = Array.from(document.querySelectorAll(container + ' tbody tr')).filter(row => 
                window.getComputedStyle(row).display !== 'none').length;
            level0Rows = document.querySelectorAll(container + ' tr[data-level="0"]').length;
            assert.equal(visibleRows, level0Rows, 'Null level defaults to 0');

            drillDowner.destroy();
        });

        QUnit.test('Handles missing column properties gracefully', function(assert) {
            const container = '#test-container';
            document.querySelector(container).innerHTML = '';

            const drillDowner = new DrillDownerNoJquery(container, testData, {
                groupOrder: ["nonexistent"],
                columns: ["alsononexistent"],
                totals: ["rolls"]
            });

            assert.ok(drillDowner instanceof DrillDownerNoJquery, 'DrillDownerNoJquery handles missing columns');
            assert.ok(document.querySelector(container + ' table.drillDowner_table'), 'Table still renders');

            drillDowner.destroy();
        });

        QUnit.test('Destroy method cleans up properly', function(assert) {
            const container = '#test-container';
            const controls = '#test-controls';
            const azbar = '#test-azbar';

            document.querySelector(container).innerHTML = '';
            document.querySelector(controls).innerHTML = '';
            document.querySelector(azbar).innerHTML = '';

            const drillDowner = new DrillDownerNoJquery(container, testData, {
                groupOrder: ["p", "c"],
                columns: ["status"],
                totals: ["rolls"],
                controlsSelector: controls,
                azBarSelector: azbar
            });

            // Verify elements exist before destroy
            assert.ok(document.querySelector(container + ' table'), 'Table exists before destroy');
            assert.ok(document.querySelector(controls).children.length > 0, 'Controls exist before destroy');
            assert.ok(document.querySelector(azbar).children.length > 0, 'AZ bar exists before destroy');

            drillDowner.destroy();

            // Verify cleanup
            assert.equal(document.querySelector(container).children.length, 0, 'Container is empty after destroy');
            assert.equal(document.querySelector(controls).children.length, 0, 'Controls are empty after destroy');
            assert.equal(document.querySelector(azbar).children.length, 0, 'AZ bar is empty after destroy');
        });
    });

    QUnit.module('DrillDownerNoJquery Static Methods', function() {
        QUnit.test('formatNumber works correctly', function(assert) {
            assert.equal(DrillDownerNoJquery.formatNumber(1234.567, 2), '1,234.57', 'Number formatted with 2 decimals');
            assert.equal(DrillDownerNoJquery.formatNumber(1000, 0), '1,000', 'Number formatted with 0 decimals');
            assert.equal(DrillDownerNoJquery.formatNumber('invalid', 2), 'invalid', 'Invalid number returned as-is');
            assert.equal(DrillDownerNoJquery.formatNumber(0, 1), '0.0', 'Zero formatted correctly');
        });
    });

    QUnit.module('DrillDownerNoJquery Grand Totals', function() {
        QUnit.test('Grand totals are calculated correctly for simple totals', function(assert) {
            const container = '#test-container';
            document.querySelector(container).innerHTML = '';

            const drillDowner = new DrillDownerNoJquery(container, testData, {
                groupOrder: ["p"],
                columns: ["status"],
                totals: ["rolls"],
                colProperties: testColProperties,
                showGrandTotals: true
            });

            // Check that grand totals object exists and has correct values
            assert.ok(drillDowner.grandTotals, 'Grand totals object exists');
            assert.ok(drillDowner.grandTotals.hasOwnProperty('rolls'), 'Grand totals contains rolls');

            // Calculate expected total manually
            const expectedRollsTotal = testData.reduce((sum, row) => sum + (row.rolls || 0), 0);
            assert.equal(drillDowner.grandTotals.rolls, expectedRollsTotal, 'Grand total for rolls is correct');

            drillDowner.destroy();
        });

        QUnit.test('Grand totals are calculated correctly for subTotalBy columns', function(assert) {
            const container = '#test-container';
            document.querySelector(container).innerHTML = '';

            const drillDowner = new DrillDownerNoJquery(container, testData, {
                groupOrder: ["p"],
                columns: ["status"],
                totals: ["quantity"],
                colProperties: testColProperties,
                showGrandTotals: true
            });

            // Check that grand totals for subTotalBy columns are objects
            assert.ok(drillDowner.grandTotals.quantity, 'Grand totals contains quantity');
            assert.equal(typeof drillDowner.grandTotals.quantity, 'object', 'Quantity grand total is an object (subtotals)');

            // Check that it has the expected unit keys
            assert.ok(drillDowner.grandTotals.quantity.hasOwnProperty('Kg'), 'Grand totals has Kg subtotal');
            assert.ok(drillDowner.grandTotals.quantity.hasOwnProperty('m'), 'Grand totals has m subtotal');

            // Calculate expected subtotals manually
            const expectedKgTotal = testData.filter(row => row.unidades === 'Kg').reduce((sum, row) => sum + (row.quantity || 0), 0);
            const expectedMTotal = testData.filter(row => row.unidades === 'm').reduce((sum, row) => sum + (row.quantity || 0), 0);

            assert.equal(drillDowner.grandTotals.quantity.Kg, expectedKgTotal, 'Kg subtotal is correct');
            assert.equal(drillDowner.grandTotals.quantity.m, expectedMTotal, 'm subtotal is correct');

            drillDowner.destroy();
        });

        QUnit.test('Table header shows grand totals when enabled', function(assert) {
            const container = '#test-container';
            document.querySelector(container).innerHTML = '';

            const drillDowner = new DrillDownerNoJquery(container, testData, {
                groupOrder: ["p"],
                columns: ["status"],
                totals: ["rolls", "quantity"],
                colProperties: testColProperties,
                showGrandTotals: true
            });

            const table = document.querySelector(container + ' table.drillDowner_table');
            const headers = table.querySelectorAll('thead th');

            // Check that headers contain grand total information
            let foundRollsGrandTotal = false;
            let foundQuantityGrandTotal = false;

            headers.forEach(header => {
                const headerHTML = header.innerHTML;
                if (headerHTML.includes('Rollos') && headerHTML.includes('<small>')) {
                    foundRollsGrandTotal = true;
                }
                if (headerHTML.includes('Cantidad') && headerHTML.includes('<small>')) {
                    foundQuantityGrandTotal = true;
                }
            });

            assert.ok(foundRollsGrandTotal, 'Rolls header contains grand total');
            assert.ok(foundQuantityGrandTotal, 'Quantity header contains grand total');

            drillDowner.destroy();
        });

        QUnit.test('Table footer (tfoot) is created when grand totals are enabled', function(assert) {
            const container = '#test-container';
            document.querySelector(container).innerHTML = '';

            const drillDowner = new DrillDownerNoJquery(container, testData, {
                groupOrder: ["p"],
                columns: ["status"],
                totals: ["rolls", "quantity"],
                colProperties: testColProperties,
                showGrandTotals: true
            });

            const table = document.querySelector(container + ' table.drillDowner_table');
            const tfoot = table.querySelector('tfoot');

            assert.ok(tfoot, 'Table footer exists when grand totals enabled');

            const tfootRow = tfoot.querySelector('tr');
            assert.ok(tfootRow, 'Footer row exists');

            const tfootCells = tfootRow.querySelectorAll('td');
            assert.ok(tfootCells.length > 0, 'Footer cells exist');

            // Check that first cell says "Total"
            const firstCellText = tfootCells[0].textContent;
            assert.ok(firstCellText.includes('Total'), 'First footer cell contains "Total"');

            drillDowner.destroy();
        });
    });

    // Start QUnit
    QUnit.start();
</script>
</body>
</html>